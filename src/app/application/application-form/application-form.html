<div class="auth-container">
  <div class="auth-card">
    <h2>
      {{ isEditMode ? "Bewerbung bearbeiten" : "Neue Bewerbung erstellen" }}
    </h2>

    @if(!isEditMode) {
    <p class="subtitle">
      Bitte fülle die folgenden Informationen aus, um eine neue Bewerbung zu
      erstellen.
    </p>
    }

    <p class="required-fields-notice">
      Felder mit einem <span class="required-asterisk">*</span> sind
      Pflichtfelder.
    </p>

    <form [formGroup]="applicationForm" (ngSubmit)="onSubmit()">
      <fieldset>
        <legend>Bewerbungsdetails</legend>

        <!-- Jobtitel -->
        <div class="form-group">
          <label for="job_title">
            Jobtitel <span class="required-asterisk">*</span>
          </label>
          <input id="job_title" type="text" formControlName="job_title" />
        </div>

        <!-- Gehaltsvorstellung -->
        <div class="form-group">
          <label for="salary_expectation">
            Gehaltsvorstellung
          </label>
          <input id="salary_expectation" type="text" formControlName="salary_expectation" />
        </div>

        <!-- Firmen-Dropdown nur im Erstellmodus anzeigen -->
        @if(!isEditMode) {
        <div class="form-group">
          <label for="company_id">
            Unternehmen <span class="required-asterisk">*</span>
          </label>
          <select id="company_id" formControlName="company_id">
            <option [ngValue]="null" disabled>
              Bitte Unternehmen auswählen
            </option>
            @for(company of companies; track company.id) {
            <option [ngValue]="company.id">{{ company.name }}</option>
            }
          </select>
        </div>
        }

        <!-- Status -->
        <div class="form-group">
          <label for="status"> Status ( bitte auswählen ) </label>
          <select id="status" formControlName="status">
            <option value="DRAFT">Entwurf</option>
            <option value="APPLIED">Beworben</option>
            <option value="INTERVIEW">Interview</option>
            <option value="OFFER">Angebot erhalten</option>
            <option value="REJECTED">Abgelehnt</option>
            <option value="WITHDRAWN">Zurückgezogen</option>
          </select>
        </div>

        <!-- ======================================================== -->
        <!-- DYNAMISCHE DATUMSFELDER - HIER WURDE DER CODE ERGÄNZT -->
        <!-- ======================================================== -->

        <!-- Zeige "Beworben am", wenn Status APPLIED ist -->
        @if(applicationForm.get('status')?.value === 'APPLIED') {
        <div class="form-group">
          <label for="applied_on">
            Beworben am <span class="required-asterisk">*</span>
          </label>
          <input id="applied_on" type="date" formControlName="applied_on" />
          @if (applicationForm.get('applied_on')?.invalid &&
          applicationForm.get('applied_on')?.touched) {
          <div class="error">Bitte geben Sie das Bewerbungsdatum ein.</div>
          }
        </div>
        }

        <!-- Zeige "Interview am", wenn Status INTERVIEW ist -->
        @if(applicationForm.get('status')?.value === 'INTERVIEW') {
        <div class="form-group">
          <label for="interview_on">
            Interview am <span class="required-asterisk">*</span>
          </label>
          <input id="interview_on" type="date" formControlName="interview_on" />
          @if (applicationForm.get('interview_on')?.invalid &&
          applicationForm.get('interview_on')?.touched) {
          <div class="error">Bitte geben Sie das Interview-Datum ein.</div>
          }
        </div>
        }

        <!-- Zeige "Angebot erhalten am", wenn Status OFFER ist -->
        @if(applicationForm.get('status')?.value === 'OFFER') {
        <div class="form-group">
          <label for="offer_on">
            Angebot erhalten am <span class="required-asterisk">*</span>
          </label>
          <input id="offer_on" type="date" formControlName="offer_on" />
          @if (applicationForm.get('offer_on')?.invalid &&
          applicationForm.get('offer_on')?.touched) {
          <div class="error">Bitte geben Sie das Angebotsdatum ein.</div>
          }
        </div>
        }

        <!-- Zeige "Abgelehnt am", wenn Status REJECTED ist -->
        @if(applicationForm.get('status')?.value === 'REJECTED') {
        <div class="form-group">
          <label for="rejected_on">
            Abgelehnt am <span class="required-asterisk">*</span>
          </label>
          <input id="rejected_on" type="date" formControlName="rejected_on" />
          @if (applicationForm.get('rejected_on')?.invalid &&
          applicationForm.get('rejected_on')?.touched) {
          <div class="error">Bitte geben Sie das Ablehnungsdatum ein.</div>
          }
        </div>
        }

        <!-- Nachhaken am (optionales Feld) -->
        <div class="form-group">
          <label for="follow_up_on">Nachhaken am</label>
          <input id="follow_up_on" type="date" formControlName="follow_up_on" />
        </div>
      </fieldset>

      <!-- ========================================================== -->
      <!-- Firmen- & Kontaktdaten - Nur im Bearbeitungsmodus sichtbar -->
      <!-- ========================================================== -->
      @if(isEditMode) {
      <div formGroupName="details">
        <!-- Firmendaten zum Bearbeiten -->
        <fieldset formGroupName="company">
          <legend>Firmendaten</legend>

          <div class="form-group">
            <label for="company-name"
              >Firmenname <span class="required-asterisk">*</span></label
            >
            <input id="company-name" type="text" formControlName="name" />
          </div>

          <div class="form-group">
            <label for="company-industry"
              >Branche <span class="required-asterisk">*</span></label
            >
            <input
              id="company-industry"
              type="text"
              formControlName="industry"
            />
          </div>

          <div class="form-group">
            <label for="company-website">Webseite</label>
            <input id="company-website" type="url" formControlName="website" />
          </div>
        </fieldset>

        <!-- Kontaktdaten zum Bearbeiten -->
        <fieldset formGroupName="contact">
          <legend>Kontaktperson</legend>
          @if
          (applicationForm.get('details.contact')?.hasError('contactIncomplete')
          && applicationForm.get('details.contact')?.touched) {
          <div class="error">
            Bitte füllen Sie entweder Vor- und Nachname aus, oder lassen Sie
            beide Felder leer.
          </div>
          }

          <div class="form-group">
            <label for="contact-firstname">Vorname</label>
            <input
              id="contact-firstname"
              type="text"
              formControlName="first_name"
            />
          </div>

          <div class="form-group">
            <label for="contact-lastname">Nachname</label>
            <input
              id="contact-lastname"
              type="text"
              formControlName="last_name"
            />
          </div>

          <div class="form-group">
            <label for="contact-email">E-Mail</label>
            <input id="contact-email" type="email" formControlName="email" />
            @if (applicationForm.get('details.contact.email')?.touched &&
            applicationForm.get('details.contact.email')?.errors?.['email']) {
            <div class="error">
              Bitte geben Sie eine gültige E-Mail-Adresse ein.
            </div>
            }
          </div>

          <div class="form-group">
            <label for="contact-position">Position</label>
            <input
              id="contact-position"
              type="text"
              formControlName="position"
            />
          </div>

          <div class="form-group">
            <label for="contact-phone">Telefon</label>
            <input id="contact-phone" type="tel" formControlName="phone" />
          </div>
        </fieldset>
      </div>
      }

      <!-- Notizen-Sektion (unverändert) -->
      @if(isEditMode) {
      <fieldset class="notes-fieldset">
        <legend>Notizen</legend>
        <div formArrayName="notes" class="notes-container">
          @if(notes.length === 0) {
          <p class="no-notes-info">Noch keine Notizen hinzugefügt.</p>
          } @for(note of notes.controls; track i; let i = $index) {
          <div [formGroupName]="i" class="note-item">
            <textarea
              formControlName="text"
              placeholder="Ihre Notiz..."
            ></textarea>
            <button
              type="button"
              (click)="onDeleteNote(i)"
              class="btn-remove-note"
              title="Notiz entfernen"
            >
              x
            </button>
          </div>
          }
        </div>
        <button type="button" (click)="onAddNote()" class="btn-add-note">
          + Neue Notiz hinzufügen
        </button>
      </fieldset>
      }

      <br />

      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="applicationForm.invalid"
      >
        {{ isEditMode ? "Änderungen speichern" : "Bewerbung erstellen" }}
      </button>
    </form>

    <div class="switch-auth-link">
      <a routerLink="/applications">Zurück zur Übersicht</a>
    </div>
  </div>
</div>
